<div id="indexDb">
    <h1>IndexDb(ver0.05)</h1>
    <p id="lastModified"></p>

    <hr>
    <details>
        <h2>使い方参考サイト</h2>
        <p><a href="https://qiita.com/yamayamasan/items/a4297e724b86f4a00fd2">Dexie.jsでIndexedDBを使ってみる【参考】</a></p>
        <p><a href="https://www.codit.work/notes/25ykyi18blgmi8fkfi66/">データベースの操作【参考】</a></p>
        <p><a href="https://noxi515.hateblo.jp/entry/2018/04/01/233950">noxi雑記【参考】</a></p>
        <p><a href="https://launchcart.jp/blog/%E3%80%90react%E3%80%91dexie-js%E3%81%A7indexeddb%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%BF%E3%81%BE%E3%81%97%E3%81%9F/">【React】Dexie.jsでIndexedDBを使ってみました</a></p>
        <p><a href="https://codesandbox.io/s/react-dexie-js-mui-j4k3n3">【React】Dexie.jsでIndexedDBを使ってみました。- Dexie.jsを使って作ってみたDEMO【参考】</a></p>
        <p><a href="https://b-risk.jp/blog/2020/07/indexeddb_and_dexie/">【スマホアプリ開発】ハイブリッドアプリ開発が楽になる js のみのデータベース【indexedDB + Dexie.js】（動作例付き）【参考】</a></p>        
    </details>
    <hr>

    <div id="table"></div>

    <div style="padding-top: 5px;">
        <input type="button" value="新規・更新" onClick="set()">
        <input type="button" value="全クリア" onClick="if (confirm('全レコード削除してよいですか？')) cle(); return false;">
    </div>

</div>
<script src="../js/util.js"></script>
<script src="../js/common.js"></script>
<script src="../js/dexie.min.js"></script>
<script src="../js/config.js"></script>
<script>
    {
        'use strict';

        const config = getconfig();
        const tableDiv = document.getElementById('table');
        var db = new Dexie(config.INDEX_DB.DB_NAME);

        // データベースにテーブルを設定 ・初期化
        db.version(config.INDEX_DB.DB_VERSION).stores({ notes: "++id, title, body, updated_at" });

        db.open().then(function (db) {
            // 接続に成功したとき
            console.log("DB connection successful.");
            alert("DB connection successful.");
        }).catch (function (err) {
            // エラーが起きたとき
            console.log("DB connection failed. : " + err);
            alert("DB connection failed. : " + err);
        });

        db.notes.add({title: "タイトル1", body: '本文1', updated_at: dateFomatYYYYMMDDhhmmss(new Date())});
        // db.notes.add({title: "タイトル2", body: '本文2', updated_at: dateFomatYYYYMMDDhhmmss(new Date())});
        // db.notes.add({title: "タイトル3", body: '本文3', updated_at: dateFomatYYYYMMDDhhmmss(new Date())});

        show_result();

        // データを保存する
        function set() {
            const id = document.getElementById('id');
            const title = document.getElementById('title');
            const body = document.getElementById('body');
            const updatedAt = document.getElementById('updated_at');
            var params = {};
            if (id.textContent !== '') {
                params.id = parseInt(id.textContent);
            }
            params.title = title.value;
            params.body = body.value;
            params.updated_at = dateFomatYYYYMMDDhhmmss(new Date(updatedAt.value), '/', ':');
            db.notes.put(params);
            show_result();
        }

        // データを全てクリアする
        function cle() {
            db.notes.clear();
            show_result();
        }

        // 対象キーのデータをクリアする
        function keyCle(id) {
            db.notes.delete(id);
            show_result();
        }

        // キー情報を取得
        function keyCopy(pId) {
            const id = document.getElementById('id');
            const title = document.getElementById('title');
            const body = document.getElementById('body');
            const updatedAt = document.getElementById('updated_at');
            db.notes.where({ id: pId })
                .toArray()
                .then(function (notes) {
                    id.textContent = notes[0].id;
                    title.value = notes[0].title;
                    body.value = notes[0].body;
                    updatedAt.value = dateFomatYYYYMMDDhhmmss(new Date(notes[0].updatedAt), '/', ':');
                });
        }

        // データの取得
        function show_result() {
            db.notes
                .toArray()
                .then(function (notes) {
                    // console.log(notes[0].id);
                    const testId = notes[0].id;
                    const testTitle = notes[0].title;
                    const testBody = notes[0].body;
                    alert(testId + testTitle + testBody);
                    // 子要素を全て削除
                    while (tableDiv.firstChild) {
                        tableDiv.removeChild(tableDiv.firstChild);
                    }
                    alert('子要素を全て削除');
                    // テーブルを作成
                    const tableElement = document.createElement('table');
                    var trElement = null;
                    var thElement = null;
                    var tdElement = null;
                    trElement = document.createElement('tr');
                    // IDヘッダを追加
                    thElement = document.createElement('th');
                    thElement.textContent = 'ID';
                    trElement.appendChild(thElement);
                    // // タイトルヘッダを追加
                    // thElement = document.createElement('th');
                    // thElement.textContent = 'タイトル';
                    // trElement.appendChild(thElement);
                    // // 本文ヘッダを追加
                    // thElement = document.createElement('th');
                    // thElement.textContent = '本文';
                    // trElement.appendChild(thElement);
                    // // 登録日時ヘッダを追加
                    // thElement = document.createElement('th');
                    // thElement.textContent = '登録日時';
                    // trElement.appendChild(thElement);
                    // テーブルエレメントの末尾に挿入
                    tableElement.appendChild(trElement);
                    // notes.forEach(function (note) {
                    //     trElement = document.createElement('tr');
                    //     // ID追加
                    //     tdElement = document.createElement('td');
                    //     tdElement.style = "border-bottom: 1px solid black;";
                    //     tdElement.textContent = note.id;
                    //     tdElement.setAttribute('onclick', `keyCopy(${note.id})`);
                    //     trElement.appendChild(tdElement);
                        // // タイトル追加
                        // tdElement = document.createElement('td');
                        // tdElement.style = "border-bottom: 1px solid black;";
                        // tdElement.textContent = note.title;
                        // trElement.appendChild(tdElement);
                        // // 本文追加
                        // tdElement = document.createElement('td');
                        // tdElement.style = "border-bottom: 1px solid black;";
                        // tdElement.textContent = note.body;
                        // trElement.appendChild(tdElement);
                        // // 登録日時追加
                        // tdElement = document.createElement('td');
                        // tdElement.style = "border-bottom: 1px solid black;";
                        // tdElement.textContent = dateFomatYYYYMMDDhhmmss(new Date(note.updated_at), '/', ':');
                        // trElement.appendChild(tdElement);
                        // // 削除ボタン追加
                        // tdElement = document.createElement('td');
                        // tdElement.textContent = '×';
                        // const message = 'ID(' + note.id + ')を削除してよいですか？';
                        // tdElement.setAttribute('onclick', `if (confirm('${message}')) keyCle(${note.id}); return false;`);
                        // trElement.appendChild(tdElement);
                        // テーブルエレメントの末尾に挿入
                    //     tableElement.appendChild(trElement);
                    // });
                    var inputElement = null;
                    trElement = document.createElement('tr');
                    // IDについてはダミーを追加
                    tdElement = document.createElement('td');
                    tdElement.id = 'id';
                    trElement.appendChild(tdElement);
                    // タイトル用テキストボックス追加
                    inputElement = document.createElement('input');
                    inputElement.id = 'title';
                    tdElement = document.createElement('td');
                    tdElement.appendChild(inputElement);
                    trElement.appendChild(tdElement);
                    // 本文用テキストボックス追加
                    inputElement = document.createElement('input');
                    inputElement.id = 'body';
                    tdElement = document.createElement('td');
                    tdElement.appendChild(inputElement);
                    trElement.appendChild(tdElement);
                    // 登録日時用テキストボックス追加
                    inputElement = document.createElement('input');
                    inputElement.id = 'updated_at';
                    inputElement.type = 'datetime';
                    inputElement.value = dateFomatYYYYMMDDhhmmss(new Date(document.lastModified), '-', ':');
                    tdElement = document.createElement('td');
                    tdElement.appendChild(inputElement);
                    trElement.appendChild(tdElement);
                    // テーブルエレメントの末尾に挿入
                    tableElement.appendChild(trElement);
                    // テーブルDIVの末尾に挿入
                    tableDiv.appendChild(tableElement);
                });
        }
    }
</script>